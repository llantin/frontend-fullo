import{j as e,aK as q,i as D,h as L,aL as B,r as m,f as N,C as y,X as b,aM as A,n as I,aN as Q}from"./index-D8RmveFg.js";import{P as H}from"./PageBreadcrumb-Dw5_9Adg.js";import{E as T,D as $,R as C,M as h,u as G,a as E}from"./server.browser-CequAlAg.js";import{b as _,F}from"./FormControl-BP6VLzH_.js";import{c as K,a as S,u as O,o as z}from"./index.esm-DbOhfXXi.js";import{a as V}from"./personService-I6xLoZZw.js";import{g as X}from"./roleService-B325pTf1.js";import{F as J,b as U,c as R}from"./Form-BCZM8NW3.js";import{F as w}from"./FormLabel-B53mBRFw.js";import{d as W,u as Y,c as Z,g as ee}from"./userService-DhqRmUgK.js";import{C as se,a as re}from"./Card-C3khdGa0.js";import"./ElementChildren-DUlSq7n6.js";const ae=({users:o=[],onEditUser:n,onDeleteUser:i})=>{T.use($);const l=[{title:"Nombres completos",data:"fullname"},{title:"Nombre de usuario",data:"username"},{title:"Rol",data:"role"},{title:"Fecha de registro",data:"created_at"},{title:"Acciones",data:null,orderable:!1,render:()=>`
        <div class="d-flex gap-1">
            <button class="btn btn-sm btn-secondary btn-edit">Editar</button>
            <button class="btn btn-sm btn-danger btn-delete">Eliminar</button>
        </div>
        `}],p=o.map(s=>({fullname:`${s.person?.name||""} ${s.person?.last_name||""}`,username:s.username,role:s.role?.name||"—",created_at:new Date(s.created_at).toLocaleDateString("es"),id:s.id,role_id:s.role_id,person_id:s.person_id})),x={responsive:!0,language:{decimal:",",thousands:".",processing:"Procesando...",search:"Buscar:",lengthMenu:"Mostrar _MENU_ registros",info:"Mostrando _START_ a _END_ de _TOTAL_ registros",zeroRecords:"No se encontraron resultados",emptyTable:"No hay datos disponibles en la tabla",paginate:{first:C.renderToStaticMarkup(e.jsx(B,{})),previous:C.renderToStaticMarkup(e.jsx(L,{})),next:C.renderToStaticMarkup(e.jsx(D,{})),last:C.renderToStaticMarkup(e.jsx(q,{}))}},createdRow:(s,r)=>{const t=s.querySelector(".btn-edit"),u=s.querySelector(".btn-delete");t&&t.addEventListener("click",()=>n(r)),u&&u.addEventListener("click",()=>i(r))},initComplete:function(){const s=this.api().table().header();s&&s.classList.add("thead-sm","text-uppercase","fs-xxs")}};return e.jsx(T,{data:p,columns:l,options:x,className:"table table-striped dt-responsive align-middle mb-0"})},te=({open:o,toggle:n,userData:i,isEditable:l,onSave:p})=>{const[x,s]=m.useState([]),[r,t]=m.useState([]),u=K({person_id:S().required("Por favor seleccione a la persona tipo usuario"),username:S().required("Por favor ingrese el nombre de usuario"),...l?{}:{password:S().required("Por favor ingrese la contraseña")},role_id:S().required("Por favor seleccione el rol de usuario")}),{handleSubmit:v,setValue:f,reset:M,register:j,formState:{errors:d}}=O({resolver:z(u)}),g=a=>{p(a)};return m.useEffect(()=>{V().then(a=>s(a)),X().then(a=>t(a))},[]),m.useEffect(()=>{i&&(f("person_id",i.person_id),f("username",i.username),f("role_id",i.role_id))},[i]),m.useEffect(()=>{o||M()},[o]),e.jsx(h,{show:o,onHide:n,centered:!0,children:e.jsxs(J,{onSubmit:v(g),children:[e.jsxs(h.Header,{children:[e.jsxs(h.Title,{children:[l?"Editar":"Crear"," usuario"]}),e.jsx("button",{type:"button",className:"btn-close",onClick:n})]}),e.jsxs(h.Body,{children:[e.jsx(N,{children:e.jsx(y,{md:12,className:"mb-3",children:e.jsxs(U,{children:[e.jsx(w,{children:"Persona de tipo usuario"}),e.jsxs(R,{...j("person_id"),isInvalid:!!d.person_id,children:[e.jsx("option",{value:"",hidden:!0,children:"Seleccionar"}),x.map(a=>e.jsxs("option",{value:a.id,children:[a.name," ",a.last_name]},a.id))]}),e.jsx(_,{type:"invalid",children:d.person_id?.message})]})})}),e.jsxs(N,{children:[e.jsx(y,{md:l?12:6,className:"mb-3",children:e.jsxs(U,{children:[e.jsx(w,{children:"Nombre de usuario"}),e.jsx(F,{type:"text",placeholder:"Ingrese nombre de usuario",autoComplete:"new-username",...j("username"),isInvalid:!!d.username}),e.jsx(_,{type:"invalid",children:d.username?.message})]})}),!l&&e.jsx(y,{md:6,className:"mb-3",children:e.jsxs(U,{children:[e.jsx(w,{children:"Contraseña"}),e.jsx(F,{type:"password",placeholder:"Ingrese contraseña",autoComplete:"new-password",...j("password"),isInvalid:!!d.password}),e.jsx(_,{type:"invalid",children:d.password?.message})]})})]}),e.jsx(N,{children:e.jsx(y,{md:12,className:"mb-3",children:e.jsxs(U,{children:[e.jsx(w,{children:"Rol asignado"}),e.jsxs(R,{...j("role_id"),isInvalid:!!d.role_id,children:[e.jsx("option",{value:"",hidden:!0,children:"Seleccionar"}),r.map(a=>e.jsx("option",{value:a.id,children:a.name},a.id))]}),e.jsx(_,{type:"invalid",children:d.role_id?.message})]})})}),e.jsxs("div",{className:"d-flex justify-content-end gap-2 mt-3",children:[e.jsx(b,{variant:"light",onClick:n,children:"Cancelar"}),e.jsx(b,{type:"submit",variant:"primary",children:"Guardar"})]})]})]})})},ne=({open:o,toggle:n,onConfirm:i,userName:l})=>e.jsxs(h,{show:o,onHide:n,centered:!0,children:[e.jsxs(h.Header,{children:[e.jsx(h.Title,{children:"Eliminar usuario"}),e.jsx("button",{type:"button",className:"btn-close",onClick:n})]}),e.jsxs(h.Body,{children:[e.jsxs("p",{children:["¿Estás seguro que deseas eliminar el usuario de ",e.jsx("strong",{children:l}),"?"]}),e.jsxs("div",{className:"d-flex justify-content-end gap-2 mt-3",children:[e.jsx(b,{variant:"light",onClick:n,children:"Cancelar"}),e.jsx(b,{variant:"danger",onClick:()=>{i(),n()},children:"Eliminar"})]})]})]}),oe=()=>{const o=A(),{data:n=[],isLoading:i}=G({queryKey:["users"],queryFn:ee,staleTime:300*1e3}),l=E({mutationFn:Z,onSuccess:s=>{o.setQueryData(["users"],(r=[])=>[...r,s.user])}}),p=E({mutationFn:({id:s,data:r})=>Y(s,r),onSuccess:s=>{o.setQueryData(["users"],(r=[])=>r.map(t=>t.id===s.user.id?s.user:t))}}),x=E({mutationFn:W,onSuccess:(s,r)=>{o.setQueryData(["users"],(t=[])=>t.filter(u=>u.id!==r))}});return{users:n,loading:i,addUser:s=>l.mutateAsync(s),editUser:(s,r)=>p.mutateAsync({id:s,data:r}),removeUser:s=>x.mutateAsync(s)}},ve=()=>{const{users:o,loading:n,addUser:i,editUser:l,removeUser:p}=oe(),[x,s]=m.useState(!1),[r,t]=m.useState(null),[u,v]=m.useState(!1),f=()=>{t(null),s(!0)},M=c=>{t(c),s(!0)},j=c=>{t(c),v(!0)},d=()=>{s(!1),t(null)},g=()=>{v(!1),t(null)},a=async c=>{try{r?(c.password||delete c.password,await l(r.id,c)):await i(c),d()}catch(P){console.error("Error al guardar usuario:",P)}},k=async()=>{if(r)try{await p(r.id),g()}catch(c){console.error("Error al eliminar usuario:",c)}};return n?e.jsx("p",{children:"Cargando usuarios..."}):e.jsxs(I,{fluid:!0,children:[e.jsx(H,{title:"Usuarios",subtitle:"Gestionar"}),e.jsx(se,{className:"mb-3",children:e.jsxs(re,{children:[e.jsxs(b,{variant:"primary",className:"mb-3",onClick:f,children:[e.jsx(Q,{className:"me-2"}),"Registrar usuario"]}),e.jsx(ae,{users:o,onEditUser:M,onDeleteUser:j})]})}),e.jsx(te,{open:x,toggle:d,userData:r,isEditable:!!r,onSave:a}),e.jsx(ne,{open:u,toggle:g,onConfirm:k,userName:r?.fullname})]})};export{ve as default};
