import{j as e,aK as U,i as Q,h as H,aL as O,r as p,f as I,C as b,X as _,a as q,aM as V,n as K,aN as J}from"./index-D8RmveFg.js";import{P as W}from"./PageBreadcrumb-Dw5_9Adg.js";import{E as P,D as X,R as M,M as v,u as Y,a as F}from"./server.browser-CequAlAg.js";import{b as C}from"./FormControl-BP6VLzH_.js";import{c as Z,f as ee,a as N,u as te,o as se,g as re}from"./index.esm-DbOhfXXi.js";import{g as ae}from"./personService-I6xLoZZw.js";import{g as ie}from"./userService-DhqRmUgK.js";import{g as ne}from"./itemService-hMfL8RRy.js";import{g as oe}from"./unitConversionService-BoAk4ZyX.js";import{F as r}from"./Form-BCZM8NW3.js";import{T as de}from"./Table-Dy5gSvTD.js";import{C as ce,a as le}from"./Card-C3khdGa0.js";import"./ElementChildren-DUlSq7n6.js";import"./FormLabel-B53mBRFw.js";const ue=({receipts:i=[],onEditReceipt:n,onDeleteReceipt:o})=>{P.use(X);const h=[{title:"Código de comprobante",data:"receipt_code"},{title:"Tipo de movimiento",data:"type"},{title:"Tipo de comprobante",data:"description"},{title:"Registrado por",data:"user_name"},{title:"Cliente o proveedor",data:"person_name"},{title:"Fecha de registro",data:"created_at"},{title:"Acciones",data:null,orderable:!1,render:()=>`
        <div class="d-flex gap-1">
          <button class="btn btn-sm btn-secondary btn-edit">Editar</button>
          <button class="btn btn-sm btn-danger btn-delete">Eliminar</button>
        </div>
        `}],g=i.map(t=>({receipt_code:t.receipt_code,type:t.type,description:t.description,user_name:`${t.user?.person?.name||""} ${t.user?.person?.last_name||""}`,person_name:`${t.person?.name||""} ${t.person?.last_name||""}`,created_at:new Date(t.created_at).toLocaleDateString("es"),id:t.id})),y={responsive:!0,language:{decimal:",",thousands:".",processing:"Procesando...",search:"Buscar:",lengthMenu:"Mostrar _MENU_ registros",info:"Mostrando _START_ a _END_ de _TOTAL_ registros",zeroRecords:"No se encontraron resultados",emptyTable:"No hay datos disponibles en la tabla",paginate:{first:M.renderToStaticMarkup(e.jsx(O,{})),previous:M.renderToStaticMarkup(e.jsx(H,{})),next:M.renderToStaticMarkup(e.jsx(Q,{})),last:M.renderToStaticMarkup(e.jsx(U,{}))}},createdRow:(t,a)=>{const d=t.querySelector(".btn-edit"),x=t.querySelector(".btn-delete");d&&d.addEventListener("click",()=>n(a)),x&&x.addEventListener("click",()=>o(a))},initComplete:function(){const t=this.api().table().header();t&&t.classList.add("thead-sm","text-uppercase","fs-xxs")}};return e.jsx(P,{data:g,columns:h,options:y,className:"table table-striped dt-responsive align-middle mb-0"})},pe=({open:i,toggle:n,receiptData:o,isEditable:h,onSave:g})=>{const[y,t]=p.useState([]),[a,d]=p.useState([]),[x,R]=p.useState([]),[A,w]=p.useState({}),[T,S]=p.useState(""),E=Z({receipt_code:N().required("Por favor ingrese el código de comprobante"),type:N().required("Por favor ingrese el tipo de comprobante"),person_id:N().required("Por favor ingrese la persona asociada al comprobante"),user_id:N().required("Por favor ingrese el usuario que registra el comprobante"),description:N().required("Por favor ingrese la descripción del comprobante"),created_at:ee().required("Por favor ingrese la fecha de registro")}),{handleSubmit:L,setValue:j,reset:c,register:u,control:B,formState:{errors:l}}=te({resolver:se(E)}),{fields:k,append:$,remove:G}=re({control:B,name:"articulos"});p.useEffect(()=>{ae().then(t),ie().then(d),ne().then(R)},[]),p.useEffect(()=>{o?(j("receipt_code",o.receipt_code),j("type",o.type),j("person_id",o.person_id),j("user_id",o.user_id),j("description",o.description),j("created_at",o.created_at?o.created_at.split("T")[0]:"")):(c({receipt_code:"",type:"",person_id:"",user_id:"",description:"",created_at:"",articulos:[]}),w({}))},[o,c,j]),p.useEffect(()=>{i||c()},[i,c]);const z=async()=>{const s=x.find(m=>m.id===Number(T));if(s){$({item_id:s.id,name:s.name,quantity:1,unit:s.unit_measurement,price:0});const m=await oe(s.unit_measurement);w(f=>({...f,[k.length]:m})),S("")}},D=s=>{g(s)};return e.jsx(v,{show:i,onHide:n,centered:!0,size:"lg",scrollable:!0,dialogClassName:"modal-dialog-scrollable",children:e.jsxs(r,{onSubmit:L(D),children:[e.jsxs(v.Header,{children:[e.jsxs(v.Title,{children:[h?"Editar":"Crear"," comprobante"]}),e.jsx("button",{type:"button",className:"btn-close",onClick:n})]}),e.jsxs(v.Body,{style:{maxHeight:"calc(100vh - 220px)",overflowY:"auto",WebkitOverflowScrolling:"touch"},children:[e.jsxs(I,{children:[e.jsx(b,{md:4,className:"mb-3",children:e.jsxs(r.Group,{children:[e.jsx(r.Label,{children:"Código de comprobante"}),e.jsx(r.Control,{type:"text",placeholder:"Ingrese código de compr.",...u("receipt_code"),isInvalid:!!l.receipt_code}),e.jsx(C,{type:"invalid",children:l.receipt_code?.message})]})}),e.jsx(b,{md:4,className:"mb-3",children:e.jsxs(r.Group,{children:[e.jsx(r.Label,{children:"Tipo de movimiento"}),e.jsxs(r.Select,{...u("type"),isInvalid:!!l.type,children:[e.jsx("option",{value:"",hidden:!0,children:"Seleccionar"}),e.jsx("option",{value:"Compra",children:"Compra"}),e.jsx("option",{value:"Venta",children:"Venta"}),e.jsx("option",{value:"Ajuste",children:"Ajuste"})]}),e.jsx(C,{type:"invalid",children:l.type?.message})]})}),e.jsx(b,{md:4,className:"mb-3",children:e.jsxs(r.Group,{children:[e.jsx(r.Label,{children:"Tipo de comprobante"}),e.jsxs(r.Select,{...u("description"),isInvalid:!!l.description,children:[e.jsx("option",{value:"",hidden:!0,children:"Seleccionar"}),e.jsx("option",{value:"Boleta",children:"Boleta"}),e.jsx("option",{value:"Factura",children:"Factura"}),e.jsx("option",{value:"Liquidación de compra",children:"Liquidación de compra"}),e.jsx("option",{value:"Nota de crédito",children:"Nota de crédito"}),e.jsx("option",{value:"Nota de débito",children:"Nota de débito"}),e.jsx("option",{value:"Guía de remisión",children:"Guía de remisión"}),e.jsx("option",{value:"Acta de regularización",children:"Acta de regularización"}),e.jsx("option",{value:"Saldo inicial",children:"Saldo inicial"})]}),e.jsx(C,{type:"invalid",children:l.description?.message})]})})]}),e.jsxs(I,{children:[e.jsx(b,{md:4,className:"mb-3",children:e.jsxs(r.Group,{children:[e.jsx(r.Label,{children:"Registrado por"}),e.jsxs(r.Select,{...u("user_id"),isInvalid:!!l.user_id,children:[e.jsx("option",{value:"",hidden:!0,children:"Seleccionar"}),a.map(s=>e.jsxs("option",{value:s.id,children:[s.person.name," ",s.person.last_name]},s.id))]}),e.jsx(C,{type:"invalid",children:l.user_id?.message})]})}),e.jsx(b,{md:4,className:"mb-3",children:e.jsxs(r.Group,{children:[e.jsx(r.Label,{children:"Cliente o proveedor"}),e.jsxs(r.Select,{...u("person_id"),isInvalid:!!l.person_id,children:[e.jsx("option",{value:"",hidden:!0,children:"Seleccionar"}),y.map(s=>e.jsxs("option",{value:s.id,children:[s.name," ",s.last_name]},s.id))]}),e.jsx(C,{type:"invalid",children:l.person_id?.message})]})}),e.jsx(b,{md:4,className:"mb-3",children:e.jsxs(r.Group,{children:[e.jsx(r.Label,{children:"Fecha de registro"}),e.jsx(r.Control,{type:"date",...u("created_at"),isInvalid:!!l.created_at}),e.jsx(C,{type:"invalid",children:l.created_at?.message})]})})]}),e.jsx("hr",{className:"mb-3"}),e.jsx("h6",{className:"fw-bold text-secondary mb-3",children:"Detalle de comprobante"}),e.jsxs(I,{className:"align-items-end mb-3",children:[e.jsx(b,{md:6,children:e.jsxs(r.Group,{children:[e.jsx(r.Label,{children:"Seleccionar artículo"}),e.jsxs(r.Select,{value:T,onChange:s=>S(s.target.value),children:[e.jsx("option",{hidden:!0,children:"Seleccionar"}),x.map(s=>e.jsx("option",{value:s.id,children:s.name},s.id))]})]})}),e.jsx(b,{md:6,children:e.jsx(_,{type:"button",variant:"light",className:"w-100",onClick:z,children:"Añadir artículo"})})]}),k.length>0&&e.jsx("div",{className:"table-responsive border rounded shadow-sm mt-3",children:e.jsxs(de,{hover:!0,className:"align-middle mb-0",children:[e.jsx("thead",{className:"table-light text-center align-middle",children:e.jsxs("tr",{children:[e.jsx("th",{style:{width:"35%"},children:"Artículo"}),e.jsx("th",{style:{width:"10%"},children:"Cantidad"}),e.jsx("th",{style:{width:"18%"},children:"Unidad comercial"}),e.jsx("th",{style:{width:"16%"},children:"Precio unitario"}),e.jsx("th",{style:{width:"20%"},children:"Acción"})]})}),e.jsx("tbody",{children:k.map((s,m)=>e.jsxs("tr",{className:"bg-white",children:[e.jsx("td",{children:e.jsx(r.Control,{type:"text",value:s.name,readOnly:!0,size:"sm",className:"bg-light border-0 fw-semibold"})}),e.jsx("td",{children:e.jsx(r.Control,{type:"number",step:"0.01",min:"1",...u(`articulos.${m}.quantity`,{valueAsNumber:!0}),size:"sm",className:"text-center"})}),e.jsx("td",{children:e.jsxs(r.Select,{size:"sm",...u(`articulos.${m}.unit`,{required:!0}),defaultValue:s.unit,children:[e.jsx("option",{value:s.unit,children:s.unit}),(A[m]||[]).filter(f=>f.unit!==s.unit).map(f=>e.jsx("option",{value:f.comercial_unit,children:f.comercial_unit},f.id))]})}),e.jsx("td",{children:e.jsx(r.Control,{type:"number",min:"0",step:"0.01",placeholder:"S/ 0.00",...u(`articulos.${m}.price`,{valueAsNumber:!0}),size:"sm",className:"text-center"})}),e.jsx("td",{className:"text-center",children:e.jsx(_,{size:"sm",variant:"outline-danger",className:"rounded-pill px-3 py-1",onClick:()=>G(m),children:"Quitar"})})]},s.id||m))})]})}),e.jsxs("div",{className:"d-flex justify-content-end gap-2 mt-3",children:[e.jsx(_,{variant:"light",onClick:n,children:"Cancelar"}),e.jsx(_,{type:"submit",variant:"primary",children:"Guardar"})]})]})]})})},me=({open:i,toggle:n,onConfirm:o,receiptCode:h})=>e.jsxs(v,{show:i,onHide:n,centered:!0,children:[e.jsxs(v.Header,{children:[e.jsx(v.Title,{children:"Eliminar comprobante"}),e.jsx("button",{type:"button",className:"btn-close",onClick:n})]}),e.jsxs(v.Body,{children:[e.jsxs("p",{children:["¿Estás seguro que deseas eliminar el comprobante ",e.jsx("strong",{children:h}),"?"]}),e.jsxs("div",{className:"d-flex justify-content-end gap-2 mt-3",children:[e.jsx(_,{variant:"light",onClick:n,children:"Cancelar"}),e.jsx(_,{variant:"danger",onClick:()=>{o(),n()},children:"Eliminar"})]})]})]}),he=async()=>{const{data:i}=await q.get("/receipts");return i.receipts},xe=async i=>{const{data:n}=await q.post("/receipts",i);return n},je=async(i,n)=>{const{data:o}=await q.put(`/receipts/${i}`,n);return o},be=async i=>{const{data:n}=await q.delete(`/receipts/${i}`);return n},ve=()=>{const i=V(),{data:n=[],isLoading:o}=Y({queryKey:["receipts"],queryFn:he,staleTime:300*1e3}),h=F({mutationFn:xe,onSuccess:t=>{i.setQueryData(["receipts"],(a=[])=>[...a,t.receipt])}}),g=F({mutationFn:({id:t,data:a})=>je(t,a),onSuccess:t=>{i.setQueryData(["receipts"],(a=[])=>a.map(d=>d.id===t.receipt.id?t.receipt:d))}}),y=F({mutationFn:be,onSuccess:(t,a)=>{i.setQueryData(["receipts"],(d=[])=>d.filter(x=>x.id!==a))}});return{receipts:n,loading:o,addReceipt:t=>h.mutateAsync(t),editReceipt:(t,a)=>g.mutateAsync({id:t,data:a}),removeReceipt:t=>y.mutateAsync(t)}},Le=()=>{const{receipts:i,loading:n,addReceipt:o,editReceipt:h,removeReceipt:g}=ve(),[y,t]=p.useState(!1),[a,d]=p.useState(null),[x,R]=p.useState(!1),A=()=>{d(null),t(!0)},w=c=>{d(c),t(!0)},T=c=>{d(c),R(!0)},S=()=>{t(!1),d(null)},E=()=>{R(!1),d(null)},L=async c=>{try{a?await h(a.id,c):(await o(c),console.log(JSON.stringify(c))),S()}catch(u){console.error("Error al guardar comprobante:",u)}},j=async()=>{if(a)try{await g(a.id),E()}catch(c){console.error("Error al eliminar comprobante:",c)}};return n?e.jsx("p",{children:"Cargando comprobantes..."}):e.jsxs(K,{fluid:!0,children:[e.jsx(W,{title:"Comprobantes",subtitle:"Gestionar"}),e.jsx(ce,{className:"mb-3",children:e.jsxs(le,{children:[e.jsxs(_,{variant:"primary",className:"mb-3",onClick:A,children:[e.jsx(J,{className:"me-2"}),"Registrar comprobante"]}),e.jsx(ue,{receipts:i,onEditReceipt:w,onDeleteReceipt:T})]})}),e.jsx(pe,{open:y,toggle:S,receiptData:a,isEditable:!!a,onSave:L}),e.jsx(me,{open:x,toggle:E,onConfirm:j,receiptCode:a?.receipt_code})]})};export{Le as default};
